Telegram Bot: SnabDesign (Agents.md)

1. üöÄ –û–±–∑–æ—Ä

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ –ª–æ–≥–∏–∫—É Telegram-–±–æ—Ç–∞, —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –Ω–∞ NestJS —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Telegraf. –ë–æ—Ç –≤—ã—Å—Ç—É–ø–∞–µ—Ç –≤ —Ä–æ–ª–∏ B2B-–ø–ª–∞—Ç—Ñ–æ—Ä–º—ã, —Å–æ–µ–¥–∏–Ω—è—é—â–µ–π –î–∏–∑–∞–π–Ω–µ—Ä–æ–≤ –∏ –ü–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤.

–î–∏–∑–∞–π–Ω–µ—Ä—ã —Å–æ–∑–¥–∞—é—Ç –∑–∞—è–≤–∫–∏ (—Ç–µ–∫—Å—Ç + —Ñ–æ—Ç–æ).

–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ –ø–æ–ª—É—á–∞—é—Ç –≤—Å–µ –∑–∞—è–≤–∫–∏ –∏ –º–æ–≥—É—Ç –Ω–∞ –Ω–∏—Ö "–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è" (—Ç–µ–∫—Å—Ç + —Ñ–æ—Ç–æ).

–î–∏–∑–∞–π–Ω–µ—Ä—ã –≤–∏–¥—è—Ç –æ—Ç–∫–ª–∏–∫–∏, –≤—ã–±–∏—Ä–∞—é—Ç –ª—É—á—à–∏–π –∏ –ø–æ–ª—É—á–∞—é—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã –ü–æ—Å—Ç–∞–≤—â–∏–∫–∞.

–ü–æ—Å—Ç–∞–≤—â–∏–∫ –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—ã–±–æ—Ä–µ –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã –î–∏–∑–∞–π–Ω–µ—Ä–∞.

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (—á–µ—Ä–µ–∑ Directus) –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

2. üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

–ë—ç–∫–µ–Ω–¥: NestJS (TypeScript)

Telegram Framework: Telegraf.js

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º: telegraf/session (–¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å—Ü–µ–Ω)

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–ª–æ—É: telegraf/scenes (Stage & SceneContext)

–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: PostgreSQL

Admin & DB GUI: Directus (–¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞—è–≤–æ–∫)

ORM (–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è): Prisma –∏–ª–∏ TypeORM (–¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ NestJS —Å Postgres)

3. üèõÔ∏è –ö–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–∞—è –ú–æ–¥–µ–ª—å –î–∞–Ω–Ω—ã—Ö (–°—É—â–Ω–æ—Å—Ç–∏ –∏ –°–≤—è–∑–∏)

–ù–∏–∂–µ –æ–ø–∏—Å–∞–Ω–∞ –æ–±–æ–±—â–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö, –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã.

3.1. –°—É—â–Ω–æ—Å—Ç—å: User (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

–ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –ª—é–±–æ–≥–æ, –∫—Ç–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –±–æ—Ç–æ–º.

–ö–ª—é—á–µ–≤—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã:

ID (–Ω–∞–ø—Ä–∏–º–µ—Ä, telegram_id) –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.

Role (–†–æ–ª—å): –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (designer, supplier –∏–ª–∏ pending –¥–ª—è –æ–∂–∏–¥–∞—é—â–∏—Ö).

Status (–°—Ç–∞—Ç—É—Å): –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (is_confirmed: true/false).

ContactInfo (–ö–æ–Ω—Ç–∞–∫—Ç—ã): –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ–±–º–µ–Ω–∞ (—Ç–µ–ª–µ—Ñ–æ–Ω, email, –∏–º—è).

InternalNotes (–ó–∞–º–µ—Ç–∫–∏): –ü–æ–ª–µ –¥–ª—è –ü–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤, –≤–∏–¥–∏–º–æe –î–∏–∑–∞–π–Ω–µ—Ä–∞–º –ø—Ä–∏ –æ—Ç–∫–ª–∏–∫–µ.

3.2. –°—É—â–Ω–æ—Å—Ç—å: Request (–ó–∞—è–≤–∫–∞)

–ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –æ–¥–Ω—É –∑–∞–¥–∞—á—É, –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—É—é –î–∏–∑–∞–π–Ω–µ—Ä–æ–º.

–ö–ª—é—á–µ–≤—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã:

ID (–£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞—è–≤–∫–∏).

Details (–î–µ—Ç–∞–ª–∏): –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ (text, images).

Status (–°—Ç–∞—Ç—É—Å): –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (open, closed).

3.3. –°—É—â–Ω–æ—Å—Ç—å: Response (–û—Ç–∫–ª–∏–∫)

–ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç –ü–æ—Å—Ç–∞–≤—â–∏–∫–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ó–∞—è–≤–∫—É.

–ö–ª—é—á–µ–≤—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã:

ID (–£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –æ—Ç–∫–ª–∏–∫–∞).

Details (–î–µ—Ç–∞–ª–∏): –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –æ—Ç–∫–ª–∏–∫–∞ (text, images).

Status (–°—Ç–∞—Ç—É—Å): –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (sent, chosen).

3.4. –ö–ª—é—á–µ–≤—ã–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Å—É—â–Ω–æ—Å—Ç—è–º–∏

User (Designer) <-> Request (–°–≤—è–∑—å –û–¥–∏–Ω-–∫–æ-–ú–Ω–æ–≥–∏–º)

–û–¥–∏–Ω User (–î–∏–∑–∞–π–Ω–µ—Ä) –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –º–Ω–æ–≥–æ Request.

–û–¥–∏–Ω Request –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –æ–¥–Ω–æ–º—É User (–î–∏–∑–∞–π–Ω–µ—Ä—É).

User (Supplier) <-> Response (–°–≤—è–∑—å –û–¥–∏–Ω-–∫–æ-–ú–Ω–æ–≥–∏–º)

–û–¥–∏–Ω User (–ü–æ—Å—Ç–∞–≤—â–∏–∫) –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–Ω–æ–≥–æ Response.

–û–¥–∏–Ω Response –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –æ–¥–Ω–æ–º—É User (–ü–æ—Å—Ç–∞–≤—â–∏–∫—É).

Request <-> Response (–°–≤—è–∑—å –û–¥–∏–Ω-–∫–æ-–ú–Ω–æ–≥–∏–º)

–û–¥–∏–Ω Request –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –º–Ω–æ–≥–æ Response.

–û–¥–∏–Ω Response –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –æ–¥–Ω–æ–º—É Request.

4. ‚öôÔ∏è –ö–ª—é—á–µ–≤—ã–µ –ü—Ä–æ—Ü–µ—Å—Å—ã –∏ –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è (–ë–∏–∑–Ω–µ—Å-–õ–æ–≥–∏–∫–∞)

–≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –æ–ø–∏—Å—ã–≤–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã.

4.1. –ü—Ä–æ—Ü–µ—Å—Å: –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –∏ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–¢—Ä–∏–≥–≥–µ—Ä: –ù–æ–≤—ã–π telegram_id –ø–∏—à–µ—Ç –±–æ—Ç—É (/start).

–î–µ–π—Å—Ç–≤–∏–µ:

–°–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞–µ—Ç User —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º pending –∏ is_confirmed = false.

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ä–æ–ª—å ("–î–∏–∑–∞–π–Ω–µ—Ä" –∏–ª–∏ "–ü–æ—Å—Ç–∞–≤—â–∏–∫").

–°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç User.role.

–°–∏—Å—Ç–µ–º–Ω–æ–µ –î–µ–π—Å—Ç–≤–∏–µ: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É (–≤ Directus).

–¢—Ä–∏–≥–≥–µ—Ä (–í–Ω–µ—à–Ω–∏–π): –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–µ–Ω—è–µ—Ç User.is_confirmed –Ω–∞ true –≤ Directus.

–°–∏—Å—Ç–µ–º–Ω–æ–µ –î–µ–π—Å—Ç–≤–∏–µ (Webhook): –ë–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç —Å–∏–≥–Ω–∞–ª –æ—Ç Directus –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç User —Å–æ–æ–±—â–µ–Ω–∏–µ "–í–∞—à–∞ —Ä–æ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞".

4.2. –ü—Ä–æ—Ü–µ—Å—Å: –°–æ–∑–¥–∞–Ω–∏–µ –ó–∞—è–≤–∫–∏ (–î–µ–π—Å—Ç–≤–∏–µ –î–∏–∑–∞–π–Ω–µ—Ä–∞)

–¢—Ä–∏–≥–≥–µ—Ä: User (—Å role = 'designer') –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏.

–î–µ–π—Å—Ç–≤–∏–µ: –°–∏—Å—Ç–µ–º–∞ (—á–µ—Ä–µ–∑ —Å—Ü–µ–Ω—É) —Å–æ–±–∏—Ä–∞–µ—Ç text –∏ images.

–°–∏—Å—Ç–µ–º–Ω–æ–µ –î–µ–π—Å—Ç–≤–∏–µ:

–°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è —Å—É—â–Ω–æ—Å—Ç—å Request.

Request.designer_id —Å–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —Å User.id.

Request.status —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ open.

–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è "–ü—Ä–æ—Ü–µ—Å—Å 4.3: –†–∞—Å—Å—ã–ª–∫–∞ –ó–∞—è–≤–∫–∏".

4.3. –ü—Ä–æ—Ü–µ—Å—Å: –†–∞—Å—Å—ã–ª–∫–∞ –ó–∞—è–≤–∫–∏ (–î–µ–π—Å—Ç–≤–∏–µ –°–∏—Å—Ç–µ–º—ã)

–¢—Ä–∏–≥–≥–µ—Ä: –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è Request —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º open.

–î–µ–π—Å—Ç–≤–∏–µ: –°–∏—Å—Ç–µ–º–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ –≤—Å–µ—Ö User, —É –∫–æ—Ç–æ—Ä—ã—Ö role = 'supplier' –ò is_confirmed = true.

–°–∏—Å—Ç–µ–º–Ω–æ–µ –î–µ–π—Å—Ç–≤–∏–µ:

–°–∏—Å—Ç–µ–º–∞ –∏—Ç–µ—Ä–∏—Ä—É–µ—Ç (–≤ —Ü–∏–∫–ª–µ) –ø–æ —Å–ø–∏—Å–∫—É –ü–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤.

–ö–∞–∂–¥–æ–º—É –ü–æ—Å—Ç–∞–≤—â–∏–∫—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–∞–Ω–Ω—ã–º–∏ Request (text, images) –∏ –∫–Ω–æ–ø–∫–æ–π "–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è", —Å–æ–¥–µ—Ä–∂–∞—â–µ–π Request.id.

4.4. –ü—Ä–æ—Ü–µ—Å—Å: –°–æ–∑–¥–∞–Ω–∏–µ –û—Ç–∫–ª–∏–∫–∞ (–î–µ–π—Å—Ç–≤–∏–µ –ü–æ—Å—Ç–∞–≤—â–∏–∫–∞)

–¢—Ä–∏–≥–≥–µ—Ä: User (—Å role = 'supplier') –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è" (—Å Request.id).

–î–µ–π—Å—Ç–≤–∏–µ: –°–∏—Å—Ç–µ–º–∞ (—á–µ—Ä–µ–∑ —Å—Ü–µ–Ω—É) —Å–æ–±–∏—Ä–∞–µ—Ç text –∏ images –¥–ª—è –æ—Ç–∫–ª–∏–∫–∞.

–°–∏—Å—Ç–µ–º–Ω–æ–µ –î–µ–π—Å—Ç–≤–∏–µ:

–°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è —Å—É—â–Ω–æ—Å—Ç—å Response.

Response.supplier_id —Å–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —Å User.id.

Response.request_id —Å–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —Å Request.id (–ø–æ–ª—É—á–µ–Ω–Ω—ã–º –∏–∑ –∫–Ω–æ–ø–∫–∏).

Response.status —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ sent.

–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è "–ü—Ä–æ—Ü–µ—Å—Å 4.5: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –î–∏–∑–∞–π–Ω–µ—Ä–∞".

4.5. –ü—Ä–æ—Ü–µ—Å—Å: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –î–∏–∑–∞–π–Ω–µ—Ä–∞ (–î–µ–π—Å—Ç–≤–∏–µ –°–∏—Å—Ç–µ–º—ã)

–¢—Ä–∏–≥–≥–µ—Ä: –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è Response.

–î–µ–π—Å—Ç–≤–∏–µ:

–°–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç Request –ø–æ Response.request_id.

–ò–∑ Request —Å–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç User (–î–∏–∑–∞–π–Ω–µ—Ä–∞) –ø–æ Request.designer_id.

–°–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç User (–ü–æ—Å—Ç–∞–≤—â–∏–∫–∞) –ø–æ Response.supplier_id, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å internal_notes.

–°–∏—Å—Ç–µ–º–Ω–æ–µ –î–µ–π—Å—Ç–≤–∏–µ:

–°–∏—Å—Ç–µ–º–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –î–∏–∑–∞–π–Ω–µ—Ä—É, —Å–æ–¥–µ—Ä–∂–∞—â–µ–µ:

–î–∞–Ω–Ω—ã–µ –æ Request (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞).

–î–∞–Ω–Ω—ã–µ –æ Response (text, images).

–î–∞–Ω–Ω—ã–µ –æ –ü–æ—Å—Ç–∞–≤—â–∏–∫–µ (contact_info.name, internal_notes).

–ö–Ω–æ–ø–∫—É "–í—ã–±—Ä–∞—Ç—å –ü–æ—Å—Ç–∞–≤—â–∏–∫–∞", —Å–æ–¥–µ—Ä–∂–∞—â—É—é Response.id.

4.6. –ü—Ä–æ—Ü–µ—Å—Å: –í—ã–±–æ—Ä –ü–æ—Å—Ç–∞–≤—â–∏–∫–∞ (–î–µ–π—Å—Ç–≤–∏–µ –î–∏–∑–∞–π–Ω–µ—Ä–∞)

–¢—Ä–∏–≥–≥–µ—Ä: User (–î–∏–∑–∞–π–Ω–µ—Ä) –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–í—ã–±—Ä–∞—Ç—å –ü–æ—Å—Ç–∞–≤—â–∏–∫–∞" (—Å Response.id).

–î–µ–π—Å—Ç–≤–∏–µ:

–°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç Response.status –Ω–∞ chosen.

(–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) –°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç Request.status –Ω–∞ closed.

–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è "–ü—Ä–æ—Ü–µ—Å—Å 4.7: –û–±–º–µ–Ω –ö–æ–Ω—Ç–∞–∫—Ç–∞–º–∏".

4.7. –ü—Ä–æ—Ü–µ—Å—Å: –û–±–º–µ–Ω –ö–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ (–î–µ–π—Å—Ç–≤–∏–µ –°–∏—Å—Ç–µ–º—ã)

–¢—Ä–∏–≥–≥–µ—Ä: Response.status –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ chosen.

–î–µ–π—Å—Ç–≤–∏–µ (–ø–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö):

–°–∏—Å—Ç–µ–º–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç Response (–ø–æ Response.id).

–ù–∞—Ö–æ–¥–∏—Ç User (–ü–æ—Å—Ç–∞–≤—â–∏–∫–∞) –ø–æ Response.supplier_id.

–ù–∞—Ö–æ–¥–∏—Ç Request –ø–æ Response.request_id.

–ù–∞—Ö–æ–¥–∏—Ç User (–î–∏–∑–∞–π–Ω–µ—Ä–∞) –ø–æ Request.designer_id.

–°–∏—Å—Ç–µ–º–Ω–æ–µ –î–µ–π—Å—Ç–≤–∏–µ (–û—Ç–ø—Ä–∞–≤–∫–∞):

–î–∏–∑–∞–π–Ω–µ—Ä—É: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è ContactInfo –ü–æ—Å—Ç–∞–≤—â–∏–∫–∞.

–ü–æ—Å—Ç–∞–≤—â–∏–∫—É: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è ContactInfo –î–∏–∑–∞–π–Ω–µ—Ä–∞ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –æ —Ç–æ–º, —á—Ç–æ –µ–≥–æ –≤—ã–±—Ä–∞–ª–∏.

5. üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ NestJS –ú–æ–¥—É–ª–µ–π (–†–µ–∞–ª–∏–∑–∞—Ü–∏—è)

/src
‚îú‚îÄ‚îÄ /app.module.ts
‚îú‚îÄ‚îÄ /bot
‚îÇ   ‚îú‚îÄ‚îÄ /bot.module.ts       # –ì–ª–∞–≤–Ω—ã–π –º–æ–¥—É–ª—å –±–æ—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ /bot.update.ts       # –û—Å–Ω–æ–≤–Ω–æ–π Update (Middleware, /start)
‚îÇ   ‚îú‚îÄ‚îÄ /bot.service.ts      # –°–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ /scenes            # –°—Ü–µ–Ω—ã Telegraf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ /onboarding.scene.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ /designer.scene.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ /supplier.scene.ts
‚îÇ   ‚îî‚îÄ‚îÄ /guards
‚îÇ       ‚îî‚îÄ‚îÄ /auth.guard.ts     # –ì–≤–∞—Ä–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ is_confirmed
‚îú‚îÄ‚îÄ /users
‚îÇ   ‚îú‚îÄ‚îÄ /users.module.ts
‚îÇ   ‚îî‚îÄ‚îÄ /users.service.ts    # –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –ë–î users
‚îú‚îÄ‚îÄ /requests
‚îÇ   ‚îú‚îÄ‚îÄ /requests.module.ts
‚îÇ   ‚îî‚îÄ‚îÄ /requests.service.ts # –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –ë–î requests
‚îú‚îÄ‚îÄ /responses
‚îÇ   ‚îú‚îÄ‚îÄ /responses.module.ts
‚îÇ   ‚îî‚îÄ‚îÄ /responses.service.ts # –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –ë–î responses
‚îú‚îÄ‚îÄ /directus
‚îÇ   ‚îî‚îÄ‚îÄ /directus.service.ts # –°–µ—Ä–≤–∏—Å –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è —Ö—É–∫–æ–≤ Directus
‚îî‚îÄ‚îÄ /main.ts


6. üß† –õ–æ–≥–∏–∫–∞ –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (–°—Ü–µ–Ω—ã –∏ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏)

–≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –æ–ø–∏—Å—ã–≤–∞–µ—Ç, –∫–∞–∫ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏–∑ –ü—É–Ω–∫—Ç–∞ 4 —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é Telegraf Scenes.

6.1. Session (–ö–æ–Ω—Ç–µ–∫—Å—Ç –°–µ—Å—Å–∏–∏)

–û–ø—Ä–µ–¥–µ–ª–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è ctx.session.

// –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å —á—Ç–æ-—Ç–æ –º–µ–∂–¥—É —Å—Ü–µ–Ω–∞–º–∏
interface AppSession extends Scenes.SceneSession<any> {
// session.role, session.is_confirmed –∏ —Ç.–¥.
// –ù–æ –ª—É—á—à–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏—Ö –∏–∑ –ë–î –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ (stateless)
}

// –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ü–µ–Ω—ã –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
interface SceneState {
text?: string;
images?: string[];
request_id?: string; // –î–ª—è —Å—Ü–µ–Ω—ã –æ—Ç–∫–ª–∏–∫–∞
}


6.2. –ì–ª–æ–±–∞–ª—å–Ω—ã–π Middleware (–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞)

(–†–µ–∞–ª–∏–∑—É–µ—Ç –ü—Ä–æ—Ü–µ—Å—Å 4.1)
–§–∞–π–ª: bot.update.ts

–î–µ–π—Å—Ç–≤–∏–µ: –ü—Ä–∏ –ª—é–±–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–õ–æ–≥–∏–∫–∞:

–ù–∞–π—Ç–∏ user –≤ –ë–î –ø–æ ctx.from.id.

–ï—Å–ª–∏ user –Ω–µ –Ω–∞–π–¥–µ–Ω:

–°–æ–∑–¥–∞—Ç—å user —Å telegram_id = ctx.from.id –∏ role = 'pending'.

–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ü–µ–Ω—É onboarding-scene: await ctx.scene.enter('onboarding-scene').

–ï—Å–ª–∏ user –Ω–∞–π–¥–µ–Ω, –Ω–æ user.is_confirmed == false:

–û—Ç–≤–µ—Ç–∏—Ç—å: "–í–∞—à–∞ —Ä–æ–ª—å –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è."

(–ï—Å–ª–∏ –æ–Ω –Ω–µ –≤ —Å—Ü–µ–Ω–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞) await ctx.scene.enter('onboarding-scene').

–ï—Å–ª–∏ user –Ω–∞–π–¥–µ–Ω –ò user.is_confirmed == true:

–°–æ—Ö—Ä–∞–Ω–∏—Ç—å user.role –≤ ctx.state.role (–∏–ª–∏ ctx.session.role) –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞.

–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º (–∫–æ–º–∞–Ω–¥–∞–º, —Å—Ü–µ–Ω–∞–º).

6.3. –°—Ü–µ–Ω–∞ 1: onboarding-scene

(–†–µ–∞–ª–∏–∑—É–µ—Ç –ü—Ä–æ—Ü–µ—Å—Å 4.1)
ID –°—Ü–µ–Ω—ã: onboarding-scene

ENTRY: –ü—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Å—Ü–µ–Ω—É (–∏–ª–∏ –ø–æ –∫–æ–º–∞–Ω–¥–µ /start –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).

–®–∞–≥ 1: –ë–æ—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—ã..."

–ö–Ω–æ–ø–∫–∏: [–Ø –î–∏–∑–∞–π–Ω–µ—Ä], [–Ø –ü–æ—Å—Ç–∞–≤—â–∏–∫].

–û–±—Ä–∞–±–æ—Ç—á–∏–∫ (Action): bot.action(['designer', 'supplier'])

–ü–æ–ª—É—á–∏—Ç—å role –∏–∑ ctx.match[0].

–û–±–Ω–æ–≤–∏—Ç—å –≤ –ë–î: users.role = role (–≥–¥–µ telegram_id = ctx.from.id).

–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ Directus –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —á–∞—Ç).

–û—Ç–≤–µ—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: "–°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ —Ä–æ–ª—å '[–†–æ–ª—å]' –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ."

await ctx.scene.leave().

6.4. –õ–æ–≥–∏–∫–∞ 2: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (Hook Directus)

(–†–µ–∞–ª–∏–∑—É–µ—Ç –ü—Ä–æ—Ü–µ—Å—Å 4.1 - –®–∞–≥ 5)
–§–∞–π–ª: directus.service.ts

–¢—Ä–∏–≥–≥–µ—Ä: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤ Directus –º–µ–Ω—è–µ—Ç is_confirmed –Ω–∞ true.

–î–µ–π—Å—Ç–≤–∏–µ (Directus Flow –∏–ª–∏ NestJS Endpoint):

Directus –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Webhook –Ω–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç NestJS.

NestJS (—á–µ—Ä–µ–∑ BotService) –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ telegram_id: "–í–∞—à–∞ —Ä–æ–ª—å [–†–æ–ª—å] –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –ú–æ–∂–µ—Ç–µ –Ω–∞—á–∏–Ω–∞—Ç—å —Ä–∞–±–æ—Ç—É. –í–≤–µ–¥–∏—Ç–µ /start".

6.5. –°—Ü–µ–Ω–∞ 2: designer-scene (–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏)

(–†–µ–∞–ª–∏–∑—É–µ—Ç –ü—Ä–æ—Ü–µ—Å—Å 4.2)
ID –°—Ü–µ–Ω—ã: designer-scene

ENTRY: –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ –∫–æ–º–∞–Ω–¥–µ ctx.hears('–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É') (—Ç–æ–ª—å–∫–æ –¥–ª—è role == 'designer').

–®–∞–≥ 1: await ctx.reply('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–∞—à–µ–π –∑–∞—è–≤–∫–∏:')

–û–±—Ä–∞–±–æ—Ç—á–∏–∫ (On 'text'):

ctx.scene.session.state.text = ctx.message.text

await ctx.reply('–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è... –ù–∞–∂–º–∏—Ç–µ "–ì–æ—Ç–æ–≤–æ", –∫–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—Ç–µ.')

–ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É [–ì–æ—Ç–æ–≤–æ].

–û–±—Ä–∞–±–æ—Ç—á–∏–∫ (On 'photo'):

const fileId = ctx.message.photo[ctx.message.photo.length - 1].file_id

ctx.scene.session.state.images.push(fileId)

–û–±—Ä–∞–±–æ—Ç—á–∏–∫ (Hears '–ì–æ—Ç–æ–≤–æ'):

–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–ü—Ä–æ—Ü–µ—Å—Å 4.2):

–í–∑—è—Ç—å text –∏ images –∏–∑ ctx.scene.session.state.

–í—ã–∑–≤–∞—Ç—å RequestsService.create({ ... }).

–†–∞—Å—Å—ã–ª–∫–∞ (–ü—Ä–æ—Ü–µ—Å—Å 4.3):

–í—ã–∑–≤–∞—Ç—å BotService.broadcastRequest(newRequest).

–í—ã—Ö–æ–¥:

await ctx.reply('–í–∞—à–∞ –∑–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º.')

await ctx.scene.leave()

6.6. –õ–æ–≥–∏–∫–∞ 3: –†–∞—Å—Å—ã–ª–∫–∞ –ó–∞—è–≤–æ–∫ (Service)

(–†–µ–∞–ª–∏–∑—É–µ—Ç –ü—Ä–æ—Ü–µ—Å—Å 4.3)
–§–∞–π–ª: bot.service.ts

–ú–µ—Ç–æ–¥: async broadcastRequest(request: Request)

–õ–æ–≥–∏–∫–∞:

const suppliers = await UsersService.find({ role: 'supplier', is_confirmed: true })

–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ (text + images) –∏ Inline-–∫–Ω–æ–ø–∫—É: [–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è]

Callback (Action ID): respond_request_${request.id}

–í —Ü–∏–∫–ª–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ + –∫–Ω–æ–ø–∫—É –∫–∞–∂–¥–æ–º—É supplier.telegram_id.

6.7. –°—Ü–µ–Ω–∞ 3: supplier-scene (–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–∫–ª–∏–∫–∞)

(–†–µ–∞–ª–∏–∑—É–µ—Ç –ü—Ä–æ—Ü–µ—Å—Å 4.4)
ID –°—Ü–µ–Ω—ã: supplier-scene

ENTRY (Action): bot.action(/respond_request_(.+)/)

const requestId = ctx.match[1]

await ctx.scene.enter('supplier-scene', { request_id: requestId })

–®–∞–≥ 1 (–≤–Ω—É—Ç—Ä–∏ —Å—Ü–µ–Ω—ã):

await ctx.reply('–í—ã –æ—Ç–≤–µ—á–∞–µ—Ç–µ –Ω–∞ –∑–∞—è–≤–∫—É. –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–∞—à–µ–≥–æ –æ—Ç–∫–ª–∏–∫–∞:')

–û–±—Ä–∞–±–æ—Ç—á–∏–∫ (Hears '–ì–æ—Ç–æ–≤–æ'):

–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–ü—Ä–æ—Ü–µ—Å—Å 4.4):

–í–∑—è—Ç—å text, images –∏–∑ session.state –∏ request_id –∏–∑ scene.state.

–í—ã–∑–≤–∞—Ç—å ResponsesService.create({ ... }).

–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–ü—Ä–æ—Ü–µ—Å—Å 4.5):

–í—ã–∑–≤–∞—Ç—å BotService.notifyDesigner(newResponse).

–í—ã—Ö–æ–¥:

await ctx.reply('–í–∞—à –æ—Ç–∫–ª–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–∏–∑–∞–π–Ω–µ—Ä—É.')

await ctx.scene.leave()

6.8. –õ–æ–≥–∏–∫–∞ 4: –û—Ç–ø—Ä–∞–≤–∫–∞ –û—Ç–∫–ª–∏–∫–∞ –î–∏–∑–∞–π–Ω–µ—Ä—É (Service)

(–†–µ–∞–ª–∏–∑—É–µ—Ç –ü—Ä–æ—Ü–µ—Å—Å 4.5)
–§–∞–π–ª: bot.service.ts

–ú–µ—Ç–æ–¥: async notifyDesigner(response: Response)

–õ–æ–≥–∏–∫–∞:

–ù–∞–π—Ç–∏ request, designer –∏ supplier (—Å –µ–≥–æ internal_notes).

–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ (–∫–∞–∫ –≤ –ø. 4.5).

–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å Inline-–∫–Ω–æ–ø–∫—É: [–í—ã–±—Ä–∞—Ç—å —ç—Ç–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞]

Callback (Action ID): choose_response_${response.id}

–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ designer.telegram_id.

6.9. –õ–æ–≥–∏–∫–∞ 5: –û–±–º–µ–Ω –ö–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ (Action)

(–†–µ–∞–ª–∏–∑—É–µ—Ç –ü—Ä–æ—Ü–µ—Å—Å—ã 4.6 –∏ 4.7)
–§–∞–π–ª: bot.update.ts

–¢—Ä–∏–≥–≥–µ—Ä (Action): bot.action(/choose_response_(.+)/)

–õ–æ–≥–∏–∫–∞:

const responseId = ctx.match[1]

–ù–∞–π—Ç–∏ response, request, supplier, designer.

–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã (–ü—Ä–æ—Ü–µ—Å—Å 4.6):

await ResponsesService.update(responseId, { status: 'chosen' })

await RequestsService.update(request.id, { status: 'closed' })

–û—Ç–ø—Ä–∞–≤–∏—Ç—å –î–∏–∑–∞–π–Ω–µ—Ä—É (–ü—Ä–æ—Ü–µ—Å—Å 4.7):

await ctx.reply('–ö–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞: \n' + supplier.contact_info)

–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ü–æ—Å—Ç–∞–≤—â–∏–∫—É (–ü—Ä–æ—Ü–µ—Å—Å 4.7):

await BotService.sendMessage(supplier.telegram_id, '–í–∞—Å –≤—ã–±—Ä–∞–ª–∏! \n–ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–∏–∑–∞–π–Ω–µ—Ä–∞: \n' + designer.contact_info)

await ctx.answerCbQuery('–ö–æ–Ω—Ç–∞–∫—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!')